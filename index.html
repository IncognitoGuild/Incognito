<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-purple-600 text-white py-4 text-center rounded-md shadow-md">
        <h1 class="text-2xl font-semibold">Incognito</h1>
        <p class="text-md">Discord Attendance.</p>
    </header>

    <main class="container mx-auto mt-8 p-4 rounded-md">
        <div id="attendance-form" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 text-center">Attendance Form</h2>
            <form id="attendance-form-element">
                <div class="mb-4">
                    <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Ingame Name:</label>
                    <input type="text" id="name" name="name" class="shadow appearance-none border rounded-full w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <div id="name-error" class="text-red-500 text-xs italic" style="display: none;"></div>
                </div>
                <div class="mb-4">
                    <label for="class" class="block text-gray-700 text-sm font-bold mb-2">Class:</label>
                    <select id="class" name="class" class="shadow appearance-none border rounded-full w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select Class</option>
                        <option value="Ranger">Ranger</option>
                        <option value="Warlock">Warlock</option>
                        <option value="ArchBishop">ArchBishop</option>
                        <option value="Sorcerer">Sorcerer</option>
                        <option value="Minstrel">Minstrel</option>
                        <option value="Guillotine Cross">Guillotine Cross</option>
                        <option value="Mechanics">Mechanics</option>
                        <option value="Wanderer">Wanderer</option>
                        <option value="Royal Guard">Royal Guard</option>
                        <option value="Rune Knigjt">Rune Knight</option>
                        <option value="Shadow Chaser">Shadow Chaser</option>
                        <option value="Shura">Shura</option>
                        <option value="Genetic">Genetic</option>
                    </select>
                    <div id="class-error" class="text-red-500 text-xs italic" style="display: none;"></div>
                </div>
                <div class="mb-4">
                    <label for="party" class="block text-gray-700 text-sm font-bold mb-2">Party:</label>
                    <select id="party" name="party" class="shadow appearance-none border rounded-full w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select Party</option>
                        <option value="puma">PUMA</option>
                        <option value="tiger">TIGER</option>
                        <option value="panda">PANDA</option>
                        <option value="lion">LION</option>
                        <option value="snake">SNAKE</option>
                        <option value="rat">RAT</option>
                        <option value="boss">BOSS</option>
                        <option value="eagle">EAGLE</option>
                    </select>
                    <div id="party-error" class="text-red-500 text-xs italic" style="display: none;"></div>
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline w-full">Submit Attendance</button>
            </form>
        </div>

        <div id="thank-you" class="bg-white rounded-lg shadow-md p-6 mb-6 text-center" style="display: none;">
            <h2 class="text-xl font-semibold text-green-600">Thank you!</h2>
            <p class="text-gray-700">Your attendance has been recorded.</p>
        </div>

        <div id="attendance-data" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 text-center">Incognito Party</h2>
            <div class="flex flex-col md:flex-row gap-8">
                <div id="puma-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">PUMA</h3>
                    <ul id="puma-list" class="space-y-2">
                        </ul>
                </div>
                <div id="tiger-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-red-700 mb-2">TIGER</h3>
                    <ul id="tiger-list" class="space-y-2">
                        </ul>
                </div>
                <div id="panda-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-green-700 mb-2">PANDA</h3>
                    <ul id="panda-list" class="space-y-2">
                        </ul>
                </div>
                <div id="lion-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-yellow-700 mb-2">LION</h3>
                    <ul id="lion-list" class="space-y-2">
                        </ul>
                </div>
                <div id="snake-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">SNAKE</h3>
                    <ul id="snake-list" class="space-y-2">
                        </ul>
                </div>
                <div id="rat-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-pink-700 mb-2">RAT</h3>
                    <ul id="rat-list" class="space-y-2">
                        </ul>
                </div>
                <div id="boss-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">BOSS</h3>
                    <ul id="boss-list" class="space-y-2">
                        </ul>
                </div>
                 <div id="eagle-party" class="w-full md:w-1/3">
                    <h3 class="text-lg font-semibold text-teal-700 mb-2">EAGLE</h3>
                    <ul id="eagle-list" class="space-y-2">
                        </ul>
                </div>
            </div>
            <p id="no-attendance" class="text-gray-500 text-center">No attendance recorded yet.</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4 text-center rounded-md mt-8">
        <p>Â© 2025 Incognito Guild. All rights reserved.</p>
    </footer>

    <script>
        const attendanceForm = document.getElementById('attendance-form-element');
        const thankYouMessage = document.getElementById('thank-you');
        const pumaList = document.getElementById('puma-list');
        const tigerList = document.getElementById('tiger-list');
        const pandaList = document.getElementById('panda-list');
        const lionList = document.getElementById('lion-list');
        const snakeList = document.getElementById('snake-list');
        const ratList = document.getElementById('rat-list');
        const bossList = document.getElementById('boss-list');
        const eagleList = document.getElementById('eagle-list');
        const noAttendanceMessage = document.getElementById('no-attendance');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const partyInput = document.getElementById('party');
        const nameError = document.getElementById('name-error');
        const classError = document.getElementById('class-error');
        const partyError = document.getElementById('party-error');

        let attendanceRecords = {
            puma: [],
            tiger: [],
            panda: [],
            lion: [],
            snake: [],
            rat: [],
            boss: [],
            eagle: []
        };

        function validateName() {
            if (!nameInput.value.trim()) {
                nameError.textContent = "Ingame Name is required";
                nameError.style.display = "block";
                return false;
            }
            nameError.style.display = "none";
            return true;
        }

        function validateClass() {
            if (!classInput.value) {
                classError.textContent = "Please select your class";
                classError.style.display = "block";
                return false;
            }
            classError.style.display = "none";
            return true;
        }

        function validateParty() {
            if (!partyInput.value) {
                partyError.textContent = "Please select your party";
                partyError.style.display = "block";
                return false;
            }
            partyError.style.display = "none";
            return true;
        }

        nameInput.addEventListener('input', validateName);
        classInput.addEventListener('change', validateClass);
        partyInput.addEventListener('change', validateParty);

        attendanceForm.addEventListener('submit', (event) => {
            event.preventDefault();

            if (!validateName() || !validateClass() || !validateParty()) {
                return;
            }

            const name = nameInput.value.trim();
            const className = classInput.value;
            const party = partyInput.value;

            const record = {
                name: name,
                class: className,
                timestamp: new Date().toLocaleString()
            };

            attendanceRecords[party].push(record);
            updateAttendanceList();
            saveAttendanceToSheets(attendanceRecords); // Changed to saveToSheets

            attendanceForm.style.display = 'none';
            thankYouMessage.style.display = 'block';

            setTimeout(() => {
                thankYouMessage.style.display = 'none';
                attendanceForm.style.display = 'block';
                nameInput.value = '';
                classInput.value = '';
                partyInput.value = '';
            }, 2000);
        });

        function updateAttendanceList() {
            if (Object.values(attendanceRecords).every(arr => arr.length === 0)) {
                noAttendanceMessage.style.display = 'block';
                pumaList.innerHTML = '';
                tigerList.innerHTML = '';
                pandaList.innerHTML = '';
                lionList.innerHTML = '';
                snakeList.innerHTML = '';
                ratList.innerHTML = '';
                bossList.innerHTML = '';
                eagleList.innerHTML = '';
            } else {
                noAttendanceMessage.style.display = 'none';

                pumaList.innerHTML = formatList(attendanceRecords.puma.sort((a, b) => a.name.localeCompare(b.name)));
                tigerList.innerHTML = formatList(attendanceRecords.tiger.sort((a, b) => a.name.localeCompare(b.name)));
                pandaList.innerHTML = formatList(attendanceRecords.panda.sort((a, b) => a.name.localeCompare(b.name)));
                lionList.innerHTML = formatList(attendanceRecords.lion.sort((a, b) => a.name.localeCompare(b.name)));
                snakeList.innerHTML = formatList(attendanceRecords.snake.sort((a, b) => a.name.localeCompare(b.name)));
                ratList.innerHTML = formatList(attendanceRecords.rat.sort((a, b) => a.name.localeCompare(b.name)));
                bossList.innerHTML = formatList(attendanceRecords.boss.sort((a, b) => a.name.localeCompare(b.name)));
                eagleList.innerHTML = formatList(attendanceRecords.eagle.sort((a, b) => a.name.localeCompare(b.name)));
            }
        }

        function formatList(records) {
            let listString = '';
            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const number = i + 1;
                listString += `<li class="py-2">
                                    <div class="flex flex-col items-start">
                                        <span class="font-semibold">${number}. ${record.name}</span>
                                        <span class="text-gray-400 text-sm mt-1">(${record.class})</span>
                                     </div>
                                  </li>`;
            }
            return listString;
        }

        // Load attendance data from Google Sheets
        function loadAttendanceFromSheets() {
            const SPREADSHEET_ID = 'https://docs.google.com/spreadsheets/d/10OgFECoyXJSR7vHvjrJ9ZNmQy0YFb1FlmV6aGXQVp3Q/edit?gid=0#gid=0'; // Replace with your sheet ID
            const SHEET_NAME = 'Sheet1'; // Replace with your sheet name
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${AIzaSyDPiwh4WSTsdt2MPA6OrJQLpXXU5uKYUMY}`; // Replace with your API key

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.values) {
                        // Clear existing data
                        attendanceRecords = { puma: [], tiger: [], panda: [], lion: [], snake: [], rat: [], boss: [], eagle: [] };
                        // Process the data from the sheet
                        data.values.slice(1).forEach(row => { // Skip the header row
                            if (row[0] && row[1] && row[2]) { // Make sure required columns exist
                                const name = row[0];
                                const className = row[1];
                                const party = row[2].toLowerCase(); // Important: make it lowercase to match our object keys
                                const timestamp = row[3] || new Date().toLocaleString(); // Use provided or generate

                                if (attendanceRecords[party]) { // Only add to valid parties
                                    attendanceRecords[party].push({ name, class: className, timestamp });
                                }
                            }
                        });
                        updateAttendanceList();
                    } else {
                        console.error('No data or invalid data received from Google Sheets');
                        attendanceRecords = { puma: [], tiger: [], panda: [], lion: [], snake: [], rat: [], boss: [], eagle: [] };
                        updateAttendanceList();
                    }
                })
                .catch(error => {
                    console.error('Error loading attendance data:', error);
                    attendanceRecords = { puma: [], tiger: [], panda: [], lion: [], snake: [], rat: [], boss: [], eagle: [] };
                    updateAttendanceList();
                });
        }

        // Save attendance data to Google Sheets
        function saveAttendanceToSheets(data) {
            const SPREADSHEET_ID = 'https://docs.google.com/spreadsheets/d/10OgFECoyXJSR7vHvjrJ9ZNmQy0YFb1FlmV6aGXQVp3Q/edit?gid=0#gid=0'; // Replace with your sheet ID
            const SHEET_NAME = 'Sheet1'; // Replace with the sheet name
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&key=${AIzaSyDPiwh4WSTsdt2MPA6OrJQLpXXU5uKYUMY}`; // Replace with your API key

            // Prepare the data for sending to Google Sheets
            const values = [];
            for (const party in data) {
                data[party].forEach(record => {
                    values.push([record.name, record.class, party.toUpperCase(), record.timestamp]); // Changed to uppercase
                });
            }

            const requestBody = {
                values: values
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(`Failed to update sheet: ${response.status} - ${err.error.message}`);
                    });
                }
                return response.json();
            })
            .then(response => {
                console.log('Attendance data updated successfully on Google Sheets:', response);
                // Reload data after successful save to reflect changes
                loadAttendanceFromSheets();
            })
            .catch(error => console.error('Error updating attendance data:', error));
        }

        loadAttendanceFromSheets(); // Load data on page load
    </script>
</body>
</html>
